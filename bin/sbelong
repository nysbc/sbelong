#!/usr/bin/env python
import os
import json
import sys
try:
    from sh import sinfo
except ImportError:
    print("Prerequisite application 'sinfo' is not available on this host.")
    print("Ensure that sinfo is isntalled and added to the shell's PATH variable.")
    print()
    sys.exit(1)
from prettytable import PrettyTable

if "SBELONG_CONF" in os.environ:
    try:
        with open(os.environ["SBELONG_CONF"],"r") as f:
            sbelong_conf=json.load(f)
        if type(sbelong_conf) is not dict:
            raise RuntimeError("sbelong config is not formatted correctly.")
    except:
        print("Failure to open %s.  sbelong config not loaded" % os.environ["SBELONG_CONF"])
        print()
        sbelong_conf={}

sbelong_partition_deny=[]
if "sbelong_partition_deny" in sbelong_conf.keys():
    if type(sbelong_conf["sbelong_partition_deny"]) == list: 
        sbelong_partition_deny=sbelong_conf["sbelong_partition_deny"]

sbelong_node_deny=[]
if "sbelong_node_deny" in sbelong_conf.keys():
    if type(sbelong_conf["sbelong_node_deny"]) == list: 
        sbelong_node_deny=sbelong_conf["sbelong_node_deny"]

nodes=[node for node in sinfo("-h", o="%n",S="+n").split("\n") if node]
nodes=[node for node in nodes if node not in sbelong_node_deny]
partitions=[partition for partition in sinfo("-h",o="%R",S="+R").split("\n") if partition]

memberships={}

for node in nodes:
    memberships[node]=[]
    lines=[line for line in sinfo("-h",o="%R,%n",S="+n",n=node).split("\n") if line]
    for line in lines:
        line=line.split(",")
        if len(line) == 2:
            if line[1].strip() == node:
                memberships[node].append(line[0].strip())

partitions=[partition for partition in partitions if not partition.strip() in sbelong_partition_deny]
table = PrettyTable()
table.field_names = ["Node"] + partitions

partition_node_count={partition : 0 for partition in partitions}
for node in nodes:
    node_row=[node]
    for partition in partitions:
        partition_member=partition in memberships[node]
        node_row.append(partition_member)
        if partition_member:
            partition_node_count[partition]+=1
    table.add_row(node_row)

table.add_divider()
table.add_row(["Total Count"]+[partition_node_count[partition] for partition in partitions])

print(table)
